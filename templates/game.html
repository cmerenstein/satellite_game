<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
   
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<style>
  #map {

    max-width: 800px;
	width: 80%;
    height: 400px;
    margin: auto;
    border-width: 1px;
    border-style: solid;
  }
  
  input {
	width: 100px;
	text-align: center;
  }
  
  img {
	max-width: 800px;
  }
  
  h2 {
	text-align: left;
  }
  
 #satellite {
   width: 80%;
   height: 500px;
   background-color: grey;
 }


</style>

</head>
<body>

<div class="container">
	<nav class='navbar navbar-default navbar-static-top'>
		<div class="container">
			<ul class=" nav navbar-nav top">
				<li class="nav-item" ><a class="navbar-brand" href="/game">Satellite Sam</a></li>
				<li class="nav-item"><a class="nav-link" href=".">How to Play</a></li>
			</ul>
		</div>
	</nav>

	<div class="jumbotron" align="center">
		<h4 id="miss"></h4>
		<a id="tryagain" href="/games" hidden><button class="btn btn-default">Try Another</button></a>
		
		<div id="satellite"></div>
		<br>
		<h4>Click on the map below to guess your location. Scroll down and hit "submit" to see how close you were.</h4>
		<p id="map"></p>
		
		<form id="latlng">
		{% csrf_token %}
			<input id="lat" name="lat" placeholder="Lat">
			<input id="lng" name="lng" placeholder="Lng">
			<div id="submit" class="btn btn-default">Submit</div>
		</form>
	</div>
</div>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAoA2-xxOTU3nBswiIvVX4BnbaWRGBCLC8&callback=initMap">
</script>

<script>

	/// GOOGLE MAPS SATELLITE WITHOUT LABELS
	var customStyle = [
		  {
			featureType: "all",
			elementType: "labels",
			stylers: [
			  { visibility: "off" }
			]
		  }, 
		  {
			featureType: "administrative",
			elementType: "geometry.stroke",
			stylers: [
				{ visibility: "off" }
			]
		  }, 
		  {
			featureType: "road",
			elementType: "geometry.stroke",
			stylers: [
				{ visibility: "off" }
			]
		  }, 
			  {
			featureType: "water",
			elementType: "geometry.stroke",
			stylers: [
				{ visibility: "off" }
			]
		  }, 
	]

	function initMap() {
        var uluru = {lat: {{city_lat}}, lng: {{city_lng}}};
        var map = new google.maps.Map(document.getElementById('satellite'), {
          tilt:0,
		  zoom: 12,
		  minZoom: 12,
          center: uluru,
		  mapTypeId: 'satellite',
		  streetViewControl: false,
        });
		map.set('styles', customStyle);
      }
  
  
  //// LEAFLET MAP FOR PICKING LOCATION
  var map = L.map('map').setView([30, 0], 2);
  mapLink = 
      '<a href="http://openstreetmap.org">OpenStreetMap</a>';
  L.tileLayer(
      'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; ' + mapLink + ' Contributors',
      maxZoom: 5,
      }).addTo(map);
          
    /* Initialize the SVG layer */
    map._initPathRoot()    

    /* We simply pick up the SVG from the map object */
    var svg = d3.select("#map").select("svg"),
    g = svg.append("g");

	map.on('click', function(e) {
		$('#lat').val(Math.round(e.latlng["lat"] * 100)/100);
		$('#lng').val(Math.round(e.latlng["lng"] * 100)/100);
		console.log(e);
		
		g.selectAll('circle').remove()
		
		g.selectAll('circle')
			.data([{'lat': e.latlng["lat"], 'lng': e.latlng["lng"]}])
			.enter()
			.append("circle")
			.style("stroke", "#474747")
			.style("fill", "red")
			.attr("r", "4")
			.attr("transform", 
				function(d) {
					console.log(d);
					console.log(map.latLngToLayerPoint([d.lat, d.lng]))
				  return "translate(" + 
					map.latLngToLayerPoint([d.lat, d.lng]).x + ","+
					map.latLngToLayerPoint([d.lat, d.lng]).y + ")";
				  }
				)
				
		
	});	
	
	function distance(lat1, lon1, lat2, lon2, unit) {
		var radlat1 = Math.PI * lat1/180
		var radlat2 = Math.PI * lat2/180
		var theta = lon1-lon2
		var radtheta = Math.PI * theta/180
		var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
		dist = Math.acos(dist)
		dist = dist * 180/Math.PI
		dist = dist * 60 * 1.1515
		if (unit=="K") { dist = dist * 1.609344 }
		if (unit=="N") { dist = dist * 0.8684 }
		return dist
	}
	
	
	$("#submit").on('click', function() {
		$('#satellite').attr('hidden', true);
		$('#latlng').attr('hidden', true);
		$("#zoom").attr('hidden', true);
		$("#tryagain").removeAttr('hidden');
		
		var new_points = [
			{"type":"city", "lat":"{{city_lat}}", "lng":"{{city_lng}}"},
			{"type":"guess", "lat":$('#lat')['0'].value, "lng":$('#lng')['0'].value}
		]
		
		g.selectAll('circle').remove()
		
		var dots = g.selectAll("circle")
			.data(new_points)
			.enter()
			.append("circle")
			.style("stroke", "#474747")
			.style("fill", function(d) {
				if (d.type == "city") {
					return "dodgerblue";
				}
				else {
					return "red";
				}})
			.attr("r", "4")
			.attr("transform", 
				function(d) {
					console.log(d);
					console.log(map.latLngToLayerPoint([d.lat, d.lng]))
				  return "translate(" + 
					map.latLngToLayerPoint([d.lat, d.lng]).x + ","+
					map.latLngToLayerPoint([d.lat, d.lng]).y + ")";
				  }
				)
				
		var missed = distance(new_points[0].lat, new_points[0].lng, new_points[1].lat, new_points[1].lng, "K")
		missed = Math.round(missed * 100) / 100
		
		if (missed <= 100) {
			$("#miss").text("Well done, only " + missed + " km away in {{city_name}}.")
		}
		else if (missed <= 1000) {
			$("#miss").text("Eh, could be worse. You were " + missed + " km away in {{city_name}}.")
		}
		else {
			$("#miss").text("Not so close, you were " + missed + " km away in {{city_name}}.")
		}
		
	// This moves dots on zoom
	map.on("viewreset", function() {
		console.log('zoom');
		dots.attr("transform", 
		function(d) {
			console.log(d);
			console.log(map.latLngToLayerPoint([d.lat, d.lng]))
		  return "translate(" + 
			map.latLngToLayerPoint([d.lat, d.lng]).x + ","+
			map.latLngToLayerPoint([d.lat, d.lng]).y + ")";
		  }
		)
      });
	  
	  
	 });
</script>

</body>
</html>